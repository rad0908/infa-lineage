<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Informatica Lineage (Strict)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* highlight rows for source/target hops */
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input[type="text"] { padding:8px; min-width: 320px; }
    button { padding:8px 12px; cursor:pointer; }
    table { border-collapse: collapse; width: 100%; margin-top: 16px; }
    th, td { border:1px solid #ddd; padding:6px 8px; font-size: 13px; vertical-align: top; }
    th { background:#f5f7fa; text-align:left; position: sticky; top: 0; }
    .muted { color:#666; font-size:12px; }
    .pill { font-size: 11px; padding:2px 6px; border-radius:12px; background:#eef2ff; }
    .right { text-align:right; }
    .wrap { white-space: pre-wrap; word-break: break-word; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
    .source-row { background: #f0fff4; border-left: 4px solid #22c55e; }  /* soft green */
    .target-row { background: #fffbea; border-left: 4px solid #f59e0b; }  /* soft amber */

    /* small legend chips */
    .legend { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .legend .chip { display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#444; }
    .legend .swatch { width:10px; height:10px; border-radius:2px; display:inline-block; }
    .legend .swatch.source { background:#22c55e; }
    .legend .swatch.target { background:#f59e0b; }
  </style>
</head>
<body>
  <h2>Informatica Lineage (Strict)</h2>

  <div class="row">
    <input id="fieldInput" type="text" placeholder="Exact column name (e.g., OUTSTANDING_BAL)" />
    <button id="btnLookup">Lookup</button>
    <button id="btnReload">Reload XMLs</button>
    <span id="status" class="muted"></span>
  </div>

  <h3>End-to-End Pairs</h3>
  <div class="legend">
    <span class="chip"><span class="swatch source"></span>Source hop</span>
    <span class="chip"><span class="swatch target"></span>Target hop</span>
  </div>

  <table id="pairsTbl">
    <thead>
      <tr>
        <th>Mapping</th>
        <th>Source</th>  <!-- DB.SCHEMA.TABLE.FIELD -->
        <th>Target</th>  <!-- DB.SCHEMA.TABLE.FIELD -->
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Summary table -->
  <h3 id="sumTitle">Summary</h3>
  <table id="summaryTbl">
    <thead>
      <tr>
        <th>Chain</th>
        <th>Order</th>
        <th>Mapping</th>
        <th>Steps</th>
        <th>Expressions</th>
        <th>Joins</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Full results table (no Level / From Type / To Type) -->
  <table id="tbl">
    <thead>
      <tr>
        <th>Chain</th>
        <th>Order</th>  <!-- step_no -->
        <th>Mapping</th>
        <th>From Instance</th>
        <th>From Port</th>
        <th>To Instance</th>
        <th>To Port</th>
        <th>Operation</th>
        <th>Expression</th>
        <th>Join</th>
        <th>Evidence</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const $  = sel => document.querySelector(sel);

    async function reloadXMLs() {
      setStatus('Reloading XMLs…');
      const r = await fetch('/api/reset', { method: 'POST' });
      const j = await r.json();
      setStatus(`Loaded: ${j.loaded?.length || 0} file(s). Errors: ${j.errors?.length || 0}`);
    }

    function setStatus(msg) { $('#status').textContent = msg || ''; }

    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function renderPairs(payload) {
      const tbody = $('#pairsTbl tbody');
      tbody.innerHTML = '';
      const rows = payload.pair_rows || [];
      for (const r of rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(r.mapping || '')}</td>
          <td class="mono wrap">${escapeHtml(r.source || '')}</td>
          <td class="mono wrap">${escapeHtml(r.target || '')}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function renderSummary(payload) {
      const tbody = $('#summaryTbl tbody');
      tbody.innerHTML = '';
      const rows = payload.summary_rows || [];
      for (const r of rows) {
        const exprPreview = (r.expr_examples || []).map(x => `<div class="mono wrap">• ${escapeHtml(x)}</div>`).join('') || '';
        const joinPreview = (r.join_examples || []).map(x => `<div class="mono wrap">• ${escapeHtml(x)}</div>`).join('') || '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="pill">${r.chain_id}</span></td>
          <td class="right">${r.seq}</td>
          <td>${r.mapping}</td>
          <td class="right">${r.steps}</td>
          <td class="wrap">${exprPreview}<div class="muted">${r.expr_count} total</div></td>
          <td class="wrap">${joinPreview}<div class="muted">${r.join_count} total</div></td>
        `;
        tbody.appendChild(tr);
      }
    }

   function renderFull(rows) {
      // Deterministic order by mapping then the stable order of the traversal (step_no if present)
      rows.sort((a,b) =>
        (a.mapping || '').localeCompare(b.mapping || '') ||
        ((a.step_no ?? 0) - (b.step_no ?? 0))
      );

      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';

      for (const r of rows) {
        const tr = document.createElement('tr');

        // highlight rule: if the FROM side is a Source, or the TO side is a Target
        const fromType = (r.from_type || '').toLowerCase();
        const toType   = (r.to_type   || '').toLowerCase();
        if (fromType === 'source') tr.classList.add('source-row');
        if (toType   === 'target') tr.classList.add('target-row');

        tr.innerHTML = `
          <td>${escapeHtml(r.mapping || '')}</td>
          <td>${escapeHtml(r.from_instance || '')}</td>
          <td class="mono wrap">${escapeHtml(r.from_port || '')}</td>
          <td>${escapeHtml(r.to_instance || '')}</td>
          <td class="mono wrap">${escapeHtml(r.to_port || '')}</td>
          <td>${escapeHtml(r.operation || '')}</td>
          <td class="mono wrap">${escapeHtml(r.expression || '')}</td>
          <td class="mono wrap">${escapeHtml(r.join_condition || '')}</td>
          <td class="mono wrap">${escapeHtml(r.evidence || '')}</td>
        `;
        tbody.appendChild(tr);
      }
      setStatus(`Rows: ${rows.length}`);
    }

    async function lookup() {
      const q = $('#fieldInput').value.trim();
      if (!q) { setStatus('Enter a column name.'); return; }
      setStatus('Summarizing…');

      // 1) Summary
      const sumRes = await fetch('/api/summary?field=' + encodeURIComponent(q));
      const sumJson = await sumRes.json();
      renderSummary(sumJson);

      // 2) Full results
      const res = await fetch('/api/lookup?field=' + encodeURIComponent(q));
      const rows = await res.json();
      renderFull(rows);
    }

    $('#btnLookup').addEventListener('click', lookup);
    $('#fieldInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') lookup(); });
    $('#btnReload').addEventListener('click', reloadXMLs);
  </script>
</body>
</html>
